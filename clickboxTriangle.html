<!DOCTYPE html>
<html lang="en" onmousemove="StoreMousePos(event)" onmousedown="MouseDown()" onmouseup="MouseUp()" onmouseleave="MouseExit()" oncontextmenu="return false;">
  <head>
  
    <script>
	  let MX = 0;  // Tracks the X position of the mouse
	  let MY = 0;  // Tracks the Y position of the mouse
	  let LMDown = false;
	  let RMDown = false;
	  let size = 5;
	
	  function CreateButton (IdNum, Type, x, y) {
	  	let grid = document.getElementById("grid-container");
	    let button = document.createElement('BUTTON');
		let p = document.createElement('p');
		let offset = "translate(" + x + "px,"+ y + "px)";
	    button.id = IdNum;
	    button.classList.add("btn" + "-" + Type);
		button.affectedButtons = [];    // stores which buttons this button will affect when pressed
  	    button.onmousedown = function(){BtnClick(IdNum)};
		button.oncontextmenu = function(e) { ""; e.preventDefault();}
		button.onmouseenter = function(){BtnMouseEnter(IdNum)}; 
		button.onmouseleave = function(){BtnMouseLeave(IdNum)};
	    button.tabindex = -1;
		p.id = IdNum + "p"
  	    p.innerHTML = "0";	
		p.classList.add("p" + "-" + Type);
		p.style.color = '#0000';
		button.appendChild(p);
  	    grid.appendChild(button);
        button.style.position = "absolute"
		button.style.transform = offset;
	  }

      function DestroyGrid (){
		if (document.body.contains(document.getElementById("grid-container")) == true){
	      document.getElementById("grid-container").remove();
        }
      }	
	  
      function MouseDown(){
        if (event.button == 0) {
		  LMDown = true;
		}
		if (event.button == 2) {
		  RMDown= true;
		}
	  }
	  
      function MouseUp(){
        if (event.button == 0) {
		  LMDown = false;
		}
		if (event.button == 2) {
		  RMDown= false;
		}
	  }
	  
      function MouseExit(){
		LMDown = false;
		RMDown= false;
	  }
	  
	  function GetRow (IdNum){
	    let i = 1;
		let inc = 1;
		let row = 1;
	    while (IdNum > i) {
		  inc += 2;
		  i += inc;	
		  row++;
		}
		return row;
	  }
	
      function ModifyButton(IdNum,Amount){
        parseInt(document.getElementById(IdNum + "p").innerHTML = parseInt(document.getElementById(IdNum + "p").innerHTML) + Amount);
		if (document.getElementById(IdNum + "p").innerHTML == 0){
		  document.getElementById(IdNum + "p").style.color = '#0000';
		}
        if (parseInt(document.getElementById(IdNum + "p").innerHTML) < 0){
		  document.getElementById(IdNum + "p").style.color = '#A80000';
		} 
		if (parseInt(document.getElementById(IdNum + "p").innerHTML) > 0) {
		  document.getElementById(IdNum + "p").style.color = '#404040';
		}
      }

      function ModifyButtonGroup(IdNum, Amount) {
	    let btn = document.getElementById(IdNum);
	  	for (let i = 0; i < btn.affectedButtons.length; i++) {
		  ModifyButton(btn.affectedButtons[i], Amount);
		}
	  }

      function InitializeButtonGroups() {
	    for (let i = 1; i < size*size; i++) {
		  GetAffectedButtons(i);
		}
	  }
	
      function GetAffectedButtons(IdNum){
	    let btn = document.getElementById(IdNum);
	    let row = GetRow (IdNum);
        btn.affectedButtons.push(IdNum);                   // center
		if (IsUpTriangle(btn) == true) {
		  if (row*row - 2*(row-1) != IdNum){
		    btn.affectedButtons.push(IdNum - 2*row + 1);   // upper left
			btn.affectedButtons.push(IdNum - 2);           // mid far left
			btn.affectedButtons.push(IdNum - 1);           // mid left
			if (row*row != IdNum) {
			  btn.affectedButtons.push(IdNum - 2*row + 2); // upper mid
			}
          }			
		  if (row*row != IdNum) {
			btn.affectedButtons.push(IdNum - 2*row + 3);   // upper right
			btn.affectedButtons.push(IdNum + 1);           // mid right
			btn.affectedButtons.push(IdNum + 2);           // mid far right
		  }
		  if (row < size) {
		    btn.affectedButtons.push(IdNum + 2*row - 1);   // lower left
			btn.affectedButtons.push(IdNum + 2*row);       // lower mid
			btn.affectedButtons.push(IdNum + 2*row + 1);   // lower right
		    if (row*row - 2*(row-1) != IdNum) {
		      btn.affectedButtons.push(IdNum + 2*row - 2); // lower far left 
            }
		    if (row*row != IdNum) {
		      btn.affectedButtons.push(IdNum + 2*row + 2); // lower far right 
            }				
		  }						
		} else {
		  btn.affectedButtons.push(IdNum - 2*row + 2);     // upper mid
		  btn.affectedButtons.push(IdNum - 1);             // mid left
		  btn.affectedButtons.push(IdNum + 1);             // mid right
		  if (row*row - 2*(row-1) + 1 != IdNum){
		    btn.affectedButtons.push(IdNum - 2*row);       // upper far left
			btn.affectedButtons.push(IdNum - 2*row + 1);   // upper left
			btn.affectedButtons.push(IdNum - 2);           // mid far left
		  }
		  
		  if (row*row - 1 != IdNum){
		    btn.affectedButtons.push(IdNum - 2*row + 3);   // upper right
			btn.affectedButtons.push(IdNum - 2*row + 4);   // upper far right
			btn.affectedButtons.push(IdNum + 2);           // mid far right
		  }
		  if (row < size) {
		    btn.affectedButtons.push(IdNum + 2*row - 1);   // lower left
			btn.affectedButtons.push(IdNum + 2*row);       // lower mid
			btn.affectedButtons.push(IdNum + 2*row + 1);   // lower right
		  }			
		}
      }	

      function BtnClick(clickID) {
	    if (event.button == 0){
          BtnLeftClick(clickID);
		} else if (event.button == 2){
		  BtnRightClick(clickID);
		}
      }
      
      function BtnLeftClick(clickID) {
        let btn = document.getElementById(clickID);
		if (btn.classList.contains("btn-up") &&
		    btn.classList.contains("btn-up-clicked") == false &&
            btn.classList.contains("btn-up-marked") == false) {
		  ModifyButtonGroup(clickID, -1);
		  btn.classList.add("btn-up-clicked");
		 }
		else if (btn.classList.contains("btn-down") &&
		         btn.classList.contains("btn-down-clicked") == false &&
				 btn.classList.contains("btn-down-marked") == false) {
		  ModifyButtonGroup(clickID, -1);
		  btn.classList.add("btn-down-clicked");
		}
	    else if (btn.classList.contains("btn-up-clicked")) {
		  ModifyButtonGroup(clickID, 1);
		  btn.classList.remove("btn-up-clicked");
		}
		else if (btn.classList.contains("btn-down-clicked")) {
		  ModifyButtonGroup(clickID, 1);
		  btn.classList.remove("btn-down-clicked");
		}
	    VictoryCheck();
      }
	  
	  function BtnRightClick(clickID) {
        let btn = document.getElementById(clickID);
		if (btn.classList.contains("btn-up") &&
            btn.classList.contains("btn-up-clicked") == false &&
			btn.classList.contains("btn-up-marked") == false) {
		  btn.classList.add("btn-up-marked");
		}
		else if (btn.classList.contains("btn-up-clicked")) {
		  ModifyButtonGroup(clickID, 1);
		  btn.classList.add("btn-up-marked");
		  btn.classList.remove("btn-up-clicked")
		}
	    else if (btn.classList.contains("btn-up-marked")) {
		  btn.classList.remove("btn-up-marked");
		} 
		else if (btn.classList.contains("btn-down") &&
                 btn.classList.contains("btn-down-clicked") == false &&
				 btn.classList.contains("btn-down-marked") == false) {
		  btn.classList.add("btn-down-marked");
		}	
		else if (btn.classList.contains("btn-down-clicked")) {
		  ModifyButtonGroup(clickID, 1);
		  btn.classList.add("btn-down-marked");
		  btn.classList.remove("btn-down-clicked");
		}
		else if (btn.classList.contains("btn-down-marked")) {
		  btn.classList.remove("btn-down-marked");
        }
      }
	  
      function BtnMouseEnter(clickID)  {
	    let btn = document.getElementById(clickID);
	    if (LMDown == true) {
		  BtnLeftClick(clickID);
		} else if (RMDown == true) {
		  BtnRightClick(clickID);
		}
		for (i = 0; i < btn.affectedButtons.length; i++) {
		  document.getElementById(btn.affectedButtons[i]).classList.add("btn-group");
		}
	  }

      function BtnMouseLeave(clickID)  {
	    let btn = document.getElementById(clickID);
		for (i = 0; i < btn.affectedButtons.length; i++) {
		  document.getElementById(btn.affectedButtons[i]).classList.remove("btn-group");
		}	  
	  }

      function VictoryCheck () {
	    let victory = true;
	    for (i = 1; i <= size*size; i++) {
		  if (document.getElementById(i + "p").innerHTML != 0) {
		    victory = false;
		  }
		}
		if (victory == true) {
		  document.getElementById("new-level").innerHTML = "Victory!";
		}
	  }
	  
	  function ResetClick () {
	    for (let IdNum = 0; IdNum < size*size; IdNum++) {
		  if (document.getElementById(IdNum + 1).classList.contains("btn-up-clicked")){
	  	  ModifyButtonGroup (IdNum + 1, 1);
		  document.getElementById(IdNum + 1).classList.remove("btn-up-clicked");
          }
		  if (document.getElementById(IdNum + 1).classList.contains("btn-down-clicked")) {
	  	    ModifyButtonGroup (IdNum + 1, 1);
		    document.getElementById(IdNum + 1).classList.remove("btn-down-clicked");
          }		
		  document.getElementById(IdNum + 1).classList.remove("btn-up-marked");		  
		  document.getElementById(IdNum + 1).classList.remove("btn-down-marked");  
	    }
	  }
	  
	  function NewLevel(){
	    let rand = 0;
		let i = 0;
		let clicks = 0;
        DestroyGrid();
		let grid = document.createElement ('div');
		grid.id = "grid-container";
		document.getElementById("demo").appendChild(grid);
		document.getElementById("new-level").innerHTML = "New Level";
		if (parseInt(document.getElementById("level-size").value) < 3){
		  document.getElementById("level-size").value = 3;
		}
		if (parseInt(document.getElementById("level-size").value) > 30){
		  document.getElementById("level-size").value = 30;
		}
	  	size = parseInt(document.getElementById("level-size").value);
	    document.querySelector(':root').style.setProperty('--size', size)
		i = 0;
	    for (let y = 0; y < size; y++) {	
          for (let x = 0; x < 1 + y*2; x++){
            i++;	  
	        if (x%2 == 0) { 
		      CreateButton (i, "up", -20 + (26*x - y*26), y*45);
	        } else {
	          CreateButton (i, "down", -20 + (26*x - y*26), y*45);
	        }
	      }  
	      x = 0;
        }
        InitializeButtonGroups();
        for (let i = 0; i < size*size; i++) {		
	  	  document.getElementById(i + 1 + "p").innerHTML = "0";
		}
		
        while (clicks < size*size/2){
	      rand = Math.trunc(Math.random()*size*size)+1;
	      if (document.getElementById(rand).classList.contains("btn-up") &&
		      document.getElementById(rand).classList.contains("btn-up-clicked") == false &&
		      document.getElementById(rand).classList.contains("btn-up-marked") == false) {
            ModifyButtonGroup (rand, 1);
            document.getElementById(rand).classList.add("btn-up-clicked");			
		    clicks++;
          } else if (document.getElementById(rand).classList.contains("btn-down") &&
		             document.getElementById(rand).classList.contains("btn-down-clicked") == false &&
                     document.getElementById(rand).classList.contains("btn-down-marked") == false) {
            ModifyButtonGroup (rand, 1);
            document.getElementById(rand).classList.add("btn-down-clicked");			
		    clicks++;		  
		  }		  
        }
		
	    for (i = 0; i < size*size; i++){
	    document.getElementById(i + 1).classList.remove("btn-up-clicked", "btn-down-clicked", "btn-up-marked", "btn-down-marked");
        }
      }	  
  
      function StoreMousePos (e){
        MX = e.clientX;
		MY = e.clientY;
	  }	 

      function IsUpTriangle (btn) {
	    if (btn.classList.contains("btn-up")) {
		  return true;
		} else {
		  return false;	
		}
	  } 	  
	  
	  function GameCycle () {
	    for ( let i = 1; i <= size*size; i++) {
		  let btn = document.getElementById(i);
		  let wasDisabled = btn.disabled;
		  let RX = MX - btn.getBoundingClientRect().left;
		  let RY = MY - btn.getBoundingClientRect().top;
		  btn.disabled = true;
		  if (IsUpTriangle(btn)) {
		    if (RY > RX*(-44/25) + 40) {
		      if (RY > RX*(44/25) - 40) {
		        if (RY < 44) {
			      if (RY > 0) {
                    btn.disabled = false;					
			  	  }				
			    }
              } 
		    }
		  }
		  else {
		    if (RY < RX*(44/25)) {
		      if (RY < RX*(-44/25) + 85) {
		        if (RY < 44) {
			      if (RY > 0) {
                    btn.disabled = false;					
			  	  }				
			    }
              } 
		    }		  
		  }
		if (wasDisabled == false &&
		    btn.disabled == true)
		  BtnMouseLeave (i);
		}
	  }
  
	</script>
	
    <link rel="stylesheet" href="css/clickboxTriangleStyles.css">
  </head>
  <body>
    <main>	  	  
	  <nav class="menu">
        <div>
		   <span class="menu-button"><a href="clickboxSquare.html">Square</a></span>
           <span><strong>Triangle</strong></span>
        </div>
      </nav>	  
	  
	  
	<div class="demo" id="demo">
	  <div>
	    <button class="new-level" id="new-level" onclick="NewLevel()" >New Level</button>
	    <input type="number" class="level-size" id="level-size" value="5" min="3" max="30">
	  </div>
      <div><button class="reset" onclick="ResetClick()">Reset</button></div>
	</div>
	  
    </main>
	
	
	<script>
	NewLevel();
	let interval = setInterval(GameCycle, 20)
	  
	</script>  	
	
	
  </body>
</html>
